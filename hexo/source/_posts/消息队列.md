---
title: 消息队列
date: 2019-06-25 20:25:16
tags: MQ
categories: 中间件
---

# 基本概念
## 什么是消息队列
消息队列允许不同的应用通过消息进行异步通信，当目标应用忙或无法连接时消息队列会暂存消息。
## 为什么使用消息队列
- 解耦：应用间约定消息格式即可，无需关心其他应用的具体实现，降低耦合度。
- 最终一致性：
- 削峰
# 高级特此
## 如何保证可靠性
保证可靠性即要求消息不发生丢失。消息系统中消息可能在生产者，消息队列，消费者处发生丢失。
- 生产者向消息队列发送消息时丢失，如网络错误或消息队列服务无法连接等情况。
  - 开启消息确认机制，要求消息队列异步发送ACK消息。生产者未收到ACK消息可再次发送消息。
  - 消息队列需开启持久化机制，若消息队列接收到消息后写入内存尚未持久化，服务器down机，此时可能发生消息丢失。消息确认机制与持久化一起使用，消息持久化成功后才给生产者发生确认消息。消息队列重启后可从持久化文件恢复消息。
  - 消费者丢失消息，消费者消费消息后尚未处理，消费者服务故障。此时消息队列以为消息已经被消费了。可关闭自动提交，消费者将消息处理完毕后异步通知消息队列。
## 如何保证幂等性
如何保证MQ消息消费幂等性需要结合具体业务，需消费者进行处理
- 消息中包含全局唯一id，消费前判断是否已经消费国。
## 消息系统设计要点
- RPC协议
- 存储选型
- 防丢防重
- 批量异步处理
- 消费关系处理
  
# 主流消息系统特性及对比